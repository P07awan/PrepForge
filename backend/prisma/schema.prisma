// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  role          Role      @default(CANDIDATE)
  subscription  Subscription @default(FREE)
  profileImage  String?
  bio           String?   @db.Text
  skills        String?   @db.Text // Store as JSON string for MySQL
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  aiInterviews     AIInterview[]
  liveInterviews   LiveInterview[] @relation("CandidateInterviews")
  conductedInterviews LiveInterview[] @relation("InterviewerInterviews")
  payments         Payment[]
  achievements     Achievement[]
  resumes          Resume[]

  @@index([email])
}

model AIInterview {
  id              String    @id @default(uuid())
  userId          String
  interviewType   InterviewType
  topic           String
  difficulty      Difficulty @default(MEDIUM)
  duration        Int       // in minutes
  status          InterviewStatus @default(SCHEDULED)
  score           Float?
  feedback        Json?     // Detailed AI feedback
  transcription   String?
  recordingUrl    String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions       Question[]
  responses       Response[]

  @@index([userId, status])
}

model LiveInterview {
  id              String    @id @default(uuid())
  candidateId     String
  interviewerId   String?
  interviewType   InterviewType
  topic           String
  scheduledAt     DateTime
  duration        Int       // in minutes
  status          InterviewStatus @default(SCHEDULED)
  roomId          String    @unique
  meetingUrl      String?
  score           Float?
  feedback        Json?
  transcription   String?
  recordingUrl    String?
  analytics       Json?     // Emotion, speech rate, filler words
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  candidate       User      @relation("CandidateInterviews", fields: [candidateId], references: [id], onDelete: Cascade)
  interviewer     User?     @relation("InterviewerInterviews", fields: [interviewerId], references: [id])
  questions       Question[]
  responses       Response[]

  @@index([candidateId, status])
  @@index([interviewerId])
}

model Question {
  id              String    @id @default(uuid())
  aiInterviewId   String?
  liveInterviewId String?
  questionText    String
  questionType    QuestionType
  expectedAnswer  String?
  difficulty      Difficulty @default(MEDIUM)
  topic           String
  order           Int
  timeAsked       DateTime  @default(now())
  createdAt       DateTime  @default(now())

  aiInterview     AIInterview?  @relation(fields: [aiInterviewId], references: [id], onDelete: Cascade)
  liveInterview   LiveInterview? @relation(fields: [liveInterviewId], references: [id], onDelete: Cascade)
  responses       Response[]

  @@index([aiInterviewId])
  @@index([liveInterviewId])
}

model Response {
  id              String    @id @default(uuid())
  questionId      String
  aiInterviewId   String?
  liveInterviewId String?
  responseText    String
  audioUrl        String?
  responseTime    Int       // in seconds
  confidence      Float?
  technicalScore  Float?
  communicationScore Float?
  aiAnalysis      Json?
  createdAt       DateTime  @default(now())

  question        Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  aiInterview     AIInterview?  @relation(fields: [aiInterviewId], references: [id], onDelete: Cascade)
  liveInterview   LiveInterview? @relation(fields: [liveInterviewId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

model Payment {
  id              String    @id @default(uuid())
  userId          String
  amount          Float
  currency        String    @default("usd")
  status          PaymentStatus
  subscription    Subscription
  stripePaymentId String    @unique
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Achievement {
  id          String    @id @default(uuid())
  userId      String
  title       String
  description String
  icon        String
  unlockedAt  DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Resume {
  id              String    @id @default(uuid())
  userId          String
  fileName        String
  fileUrl         String
  fileSize        Int       // in bytes
  fileType        String    // pdf, docx
  jobRole         String
  targetCompany   String?
  analysis        Json?     // AI analysis results with sections
  overallScore    Float?    // 0-100 score
  matchPercentage Float?    // Job role match percentage
  strengths       Json?     // Array of strength points
  improvements    Json?     // Array of improvement suggestions
  keywords        Json?     // Missing and present keywords
  sections        Json?     // Section-wise analysis
  status          ResumeStatus @default(PROCESSING)
  processedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
}

// Enums
enum Role {
  CANDIDATE
  INTERVIEWER
  ADMIN
}

enum Subscription {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

enum InterviewType {
  TECHNICAL
  HR
  APTITUDE
  BEHAVIORAL
  DOMAIN_SPECIFIC
  CODING
  SYSTEM_DESIGN
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum InterviewStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum QuestionType {
  MULTIPLE_CHOICE
  CODING
  OPEN_ENDED
  BEHAVIORAL
  TECHNICAL
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ResumeStatus {
  PROCESSING
  COMPLETED
  FAILED
}
